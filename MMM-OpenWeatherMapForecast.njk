<div class="wrapper {{ config.forecastLayout }}{% if config.colored %} colored{% endif %}{% if config.showInlineIcons %} inline-icons{% endif %}{% if config.forecastHeaderText %} with-forecast-header{% endif %}">

  {% if loading %}
    <div class="dimmed light small">{{ phrases.loading | safe }}</div>
  {% else %}

    {% macro precipitation_block(p, showIcons, layout, inlineIcons) %}
      <span class="precipitation-container">
        {% if p and p.accumulation %}
          {% if showIcons and layout == "tiled" %}
            {% if p.accumulationtype == "rain" %}
              <img class="inline-icon rain" src="{{ inlineIcons.rain }}" loading="lazy" />
            {% elif p.accumulationtype == "snow" %}
              <img class="inline-icon snow" src="{{ inlineIcons.snow }}" loading="lazy" />
            {% endif %}
          {% endif %}
          {% if p.pop is defined %}
            <span class="pop">{{ p.pop }}</span>
          {% endif %}
          <span class="accumulation">{{ p.accumulation }}</span>
        {% else %}
          {% if showIcons %}
            <img class="inline-icon rain" src="{{ inlineIcons.rain }}" loading="lazy" />
          {% endif %}
          <span class="pop">0%</span>
        {% endif %}
      </span>
    {% endmacro %}

    {% macro wind_block(w, showIcons, layout, inlineIcons) %}
      <span class="wind-container">
        {% if showIcons and layout == "tiled" %}
          <img class="inline-icon wind-icon" src="{{ inlineIcons.wind }}" loading="lazy" />
        {% endif %}
        <span class="wind-speed">{{ w.windSpeed }}</span>
        {% if w.windGust %}
          <span class="wind-gusts">{{ w.windGust }}</span>
        {% endif %}
      </span>
    {% endmacro %}

    {# -------------- Current Conditions -------------- #}
    {% if config.showCurrentConditions %}
      <div class="current-conditions-wrapper icon-set-{{ config.iconset }}">
        <span class="current-conditions-wrapper">
          {% if forecast.currently.animatedIconId %}
            <canvas
              class="skycon-{{ identifier }} current icon current"
              id="{{ forecast.currently.animatedIconId }}"
              data-animated-icon-name="{{ forecast.currently.animatedIconName }}"
              width="{{ animatedIconSizes.main }}"
              height="{{ animatedIconSizes.main }}">
            </canvas>
          {% else %}
            <img
              class="current icon current"
              src="{{ forecast.currently.iconPath }}"
              loading="lazy"
              alt="Current weather icon" />
          {% endif %}

          <span class="current temperature bright large light"
                aria-label="Current temperature">
            {{ forecast.currently.temperature }}
          </span>

          {% if config.showFeelsLike %}
            <span class="current feelslike dimmed light"
                  aria-label="Feels like temperature">
              {{ forecast.currently.feelslike }}
            </span>
          {% endif %}
        </span>
      </div>
    {% endif %}

    {# -------------- Extra Current Conditions -------------- #}
    {% if config.showExtraCurrentConditions %}
      <div class="extra-current-conditions-wrapper small bright">
        <span class="temperature-container">
          <span class="high-temperature">{{ forecast.currently.tempRange.high }}</span>
          <span class="temperature-separator dimmed">/</span>
          <span class="low-temperature">{{ forecast.currently.tempRange.low }}</span>
        </span>

        {% if config.showPrecipitation %}
          {{ precipitation_block(forecast.currently.precipitation, config.showInlineIcons, config.forecastLayout, inlineIcons) }}
        {% endif %}

        {% if config.showWind %}
          {{ wind_block(forecast.currently.wind, config.showInlineIcons, config.forecastLayout, inlineIcons) }}
        {% endif %}
      </div>
    {% endif %}

    {# -------------- Summary -------------- #}
    {% if config.showSummary %}
      <div class="summary-wrapper small">
        <div class="summary">{{ forecast.summary }}</div>
      </div>
    {% endif %}

    {# -------------- Forecast Title -------------- #}
    {% if config.forecastHeaderText and (config.showHourlyForecast or config.showDailyForecast) %}
      <header class="module-header forecast-header">
        {{ config.forecastHeaderText | safe }}
      </header>
    {% endif %}

    {# -------------- Forecast -------------- #}
    {% if config.showHourlyForecast or config.showDailyForecast %}
      <div class="forecast-container icon-set-{{ config.iconset }}">

        {% if config.showForecastTableColumnHeaderIcons and config.forecastLayout == "table" %}
          <div class="header-row">
            <span class="date-time-header">&nbsp;</span>
            <span class="weather-icon-header">&nbsp;</span>
            <span class="temperature-header">&nbsp;</span>

            {% if config.showPrecipitation %}
              <span class="precipitation-header">
                <img class="inline-icon rain" src="{{ inlineIcons.rain }}" loading="lazy" />
              </span>
            {% endif %}

            {% if config.showWind %}
              <span class="wind-header">
                <img class="inline-icon wind" src="{{ inlineIcons.wind }}" loading="lazy" />
              </span>
            {% endif %}
          </div>
        {% endif %}

        {# -------- Hourly Forecast -------- #}
        {% if config.showHourlyForecast %}
          {% for h in forecast.hourly %}
            <div class="forecast-item hourly">
              <span class="time">{{ h.time }}</span>

              <span class="forecast-icon-container">
                {% if h.animatedIconId %}
                  <canvas
                    class="skycon-{{ identifier }} forecast-icon"
                    data-animated-icon-name="{{ h.animatedIconName }}"
                    id="{{ h.animatedIconId }}"
                    width="{{ animatedIconSizes.forecast }}"
                    height="{{ animatedIconSizes.forecast }}">
                  </canvas>
                {% else %}
                  <img
                    class="forecast-icon"
                    src="{{ h.iconPath }}"
                    loading="lazy"
                    alt="Hourly weather icon" />
                {% endif %}
              </span>

              <span class="temperature small">{{ h.temperature }}</span>

              {% if config.showPrecipitation %}
                {{ precipitation_block(h.precipitation, config.showInlineIcons, config.forecastLayout, inlineIcons) }}
              {% endif %}

              {% if config.showWind %}
                {{ wind_block(h.wind, config.showInlineIcons, config.forecastLayout, inlineIcons) }}
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}

        {# -------- Daily Forecast -------- #}
        {% if config.showDailyForecast %}
          {% for d in forecast.daily %}
            <div class="forecast-item daily">
              <span class="day-name">{{ d.day }}</span>

              <span class="forecast-icon-container">
                {% if d.animatedIconId %}
                  <canvas
                    class="skycon-{{ identifier }} forecast-icon"
                    data-animated-icon-name="{{ d.animatedIconName }}"
                    id="{{ d.animatedIconId }}"
                    width="{{ animatedIconSizes.forecast }}"
                    height="{{ animatedIconSizes.forecast }}">
                  </canvas>
                {% else %}
                  <img
                    class="forecast-icon"
                    src="{{ d.iconPath }}"
                    loading="lazy"
                    alt="Daily weather icon" />
                {% endif %}
              </span>

              <span class="temperature-container small">
                <span class="high-temperature">{{ d.tempRange.high }}</span>
                <span class="temperature-separator dimmed">/</span>
                <span class="low-temperature">{{ d.tempRange.low }}</span>
              </span>

              {% if config.showPrecipitation %}
                {{ precipitation_block(d.precipitation, config.showInlineIcons, config.forecastLayout, inlineIcons) }}
              {% endif %}

              {% if config.showWind %}
                {{ wind_block(d.wind, config.showInlineIcons, config.forecastLayout, inlineIcons) }}
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}

      </div>
    {% endif %}

    <div class="meta-timestamp"
         id="{{ moduleTimestampIdPrefix + identifier }}"
         data-timestamp="{{ timeStamp }}">
    </div>

  {% endif %}
</div>
